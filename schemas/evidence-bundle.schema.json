{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://ai-hpp.org/schemas/evidence-bundle.schema.json",
  "title": "Evidence Bundle (RIR-Compatible)",
  "description": "Structured Evidence Vault bundle for decision traceability, escalation snapshots, and court-grade export preparation.",
  "type": "object",
  "required": [
    "bundle_id",
    "decision_id",
    "timestamp",
    "inputs",
    "outputs",
    "approvals",
    "hash"
  ],
  "properties": {
    "bundle_id": {
      "type": "string",
      "description": "Unique evidence bundle identifier."
    },
    "decision_id": {
      "type": "string",
      "description": "Identifier linking evidence to a decision event."
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "RFC3339 timestamp when the bundle was created."
    },
    "inputs": {
      "type": "array",
      "description": "Input records or references used by the decision.",
      "items": {
        "type": "object",
        "description": "Items."
      }
    },
    "outputs": {
      "type": "array",
      "description": "Output records emitted by the decision.",
      "items": {
        "type": "object",
        "description": "Items."
      }
    },
    "approvals": {
      "type": "array",
      "description": "Human approvals captured for HITL-controlled operations.",
      "items": {
        "type": "object",
        "required": [
          "approver",
          "role",
          "approved_at"
        ],
        "properties": {
          "approver": {
            "type": "string",
            "description": "Approver identity."
          },
          "role": {
            "type": "string",
            "description": "Approver governance role."
          },
          "approved_at": {
            "type": "string",
            "format": "date-time",
            "description": "Approval timestamp."
          }
        },
        "additionalProperties": false,
        "description": "Items."
      }
    },
    "hash": {
      "type": "string",
      "description": "Tamper-evident digest of the bundle payload."
    },
    "decision_skeleton": {
      "type": "object",
      "description": "Always-on structural trace for high-frequency decision events.",
      "required": [
        "decision_id",
        "timestamp",
        "chosen_action",
        "policy_envelope_id",
        "policy_hash",
        "model_version_hash",
        "risk_classification",
        "constraints_triggered",
        "evidence_refs"
      ],
      "properties": {
        "decision_id": {
          "type": "string",
          "description": "Decision id."
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp."
        },
        "chosen_action": {
          "type": "string",
          "description": "Chosen action."
        },
        "policy_envelope_id": {
          "type": "string",
          "description": "Policy envelope id."
        },
        "policy_hash": {
          "type": "string",
          "description": "Policy hash."
        },
        "model_version_hash": {
          "type": "string",
          "description": "Model version hash."
        },
        "risk_classification": {
          "type": "string",
          "enum": [
            "low",
            "medium",
            "high",
            "critical"
          ],
          "description": "Risk classification."
        },
        "constraints_triggered": {
          "type": "array",
          "items": {
            "type": "string",
            "description": "Items."
          },
          "description": "Constraints triggered."
        },
        "evidence_refs": {
          "type": "array",
          "items": {
            "type": "string",
            "description": "Items."
          },
          "description": "Evidence refs."
        }
      },
      "additionalProperties": false
    },
    "alternatives_top_k": {
      "type": "array",
      "description": "Aggregated alternatives retained for decision rationale without full raw dumps.",
      "minItems": 1,
      "maxItems": 5,
      "items": {
        "type": "object",
        "required": [
          "action_type",
          "expected_impact_range",
          "expected_risk_range",
          "rejection_reason_code"
        ],
        "properties": {
          "action_type": {
            "type": "string",
            "description": "Action type."
          },
          "expected_impact_range": {
            "type": "string",
            "description": "Expected impact range."
          },
          "expected_risk_range": {
            "type": "string",
            "description": "Expected risk range."
          },
          "rejection_reason_code": {
            "type": "string",
            "enum": [
              "violates_policy",
              "higher_risk",
              "lower_confidence",
              "requires_hitl",
              "outside_envelope"
            ],
            "description": "Rejection reason code."
          }
        },
        "additionalProperties": false,
        "description": "Items."
      }
    },
    "escalation_snapshot": {
      "type": "object",
      "description": "Expanded record stored when escalation, anomaly, or policy override triggers fire.",
      "properties": {
        "trigger": {
          "type": "string",
          "description": "Trigger."
        },
        "input_state_hash": {
          "type": "string",
          "description": "Input state hash."
        },
        "full_input_record": {
          "type": "object",
          "description": "Full input record."
        },
        "risk_assessment_breakdown": {
          "type": "object",
          "description": "Risk assessment breakdown."
        },
        "constraint_evaluation": {
          "type": "array",
          "items": {
            "type": "object",
            "description": "Items."
          },
          "description": "Constraint evaluation."
        },
        "multi_agent_dissent": {
          "type": "array",
          "items": {
            "type": "object",
            "description": "Items."
          },
          "description": "Multi agent dissent."
        },
        "human_decision": {
          "type": "object",
          "description": "Human decision."
        },
        "accountability_signatures": {
          "$ref": "#/$defs/accountability_signatures"
        },
        "pre_state": {
          "type": "object",
          "description": "Pre state."
        },
        "post_state": {
          "type": "object",
          "description": "Post state."
        },
        "escalation_timeout_triggered": {
          "type": "boolean",
          "description": "Whether escalation timeout fired before human response."
        },
        "safe_state_entered": {
          "type": "boolean",
          "description": "Whether configured safe state was entered on escalation timeout."
        },
        "escalation_timeout_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Configured escalation timeout in milliseconds for the evaluated event."
        },
        "override_actor_role": {
          "type": "string",
          "description": "Role of the human actor who applied override."
        },
        "override_reason_code": {
          "type": "string",
          "description": "Controlled reason code for human override."
        },
        "override_latency_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Measured time to apply human override in milliseconds."
        },
        "override_frequency_counter": {
          "type": "integer",
          "minimum": 0,
          "description": "Counter of override occurrences within implementation-defined review window."
        }
      },
      "additionalProperties": false
    },
    "financial_request_event": {
      "type": "object",
      "description": "Structured event record for financial solicitation patterns to support court-grade export traceability.",
      "properties": {
        "detected": {
          "type": "boolean",
          "description": "Whether a financial request event was detected."
        },
        "amount": {
          "type": "number",
          "description": "Requested amount when available."
        },
        "currency": {
          "type": "string",
          "description": "ISO currency code when available."
        },
        "request_channel": {
          "type": "string",
          "description": "Interaction channel for the request event."
        }
      },
      "additionalProperties": false
    },
    "dependency_signal_score": {
      "type": "number",
      "description": "Quantified dependency signal score captured for exploitative manipulation safeguards."
    },
    "identity_simulation_flag": {
      "type": "boolean",
      "description": "Flag indicating possible simulation of a specific real person identity."
    },
    "monetary_threshold_trigger": {
      "type": "boolean",
      "description": "Indicates whether monetary risk threshold triggers were activated."
    },
    "escalation_reason_code": {
      "type": "string",
      "description": "Reason code for escalation, including exploitative behavioral risk pathways."
    },
    "accountability_signatures": {
      "$ref": "#/$defs/accountability_signatures"
    },
    "redaction_policy": {
      "type": "object",
      "description": "Redaction controls that preserve taxonomy, risk, constraints, and escalation signals.",
      "required": [
        "policy_id",
        "preserved_fields"
      ],
      "properties": {
        "policy_id": {
          "type": "string",
          "description": "Policy id."
        },
        "preserved_fields": {
          "type": "array",
          "items": {
            "type": "string",
            "description": "Items."
          },
          "description": "Preserved fields."
        },
        "redacted_fields": {
          "type": "array",
          "items": {
            "type": "string",
            "description": "Items."
          },
          "description": "Redacted fields."
        }
      },
      "additionalProperties": false
    },
    "raw_artifact_hash": {
      "type": "string",
      "description": "raw artifact hash field."
    },
    "summary_artifact_hash": {
      "type": "string",
      "description": "summary artifact hash field."
    },
    "source_system_id": {
      "type": "string",
      "description": "source system id field."
    },
    "cross_check_result": {
      "type": "string",
      "description": "cross check result field."
    },
    "kpi_metric": {
      "type": "number",
      "description": "kpi metric field."
    },
    "safety_threshold_version": {
      "type": "string",
      "description": "safety threshold version field."
    },
    "escalation_rate_window": {
      "type": "number",
      "description": "escalation rate window field."
    },
    "policy_override_count": {
      "type": "integer",
      "minimum": 0,
      "description": "policy override count field."
    },
    "tool_name": {
      "type": "string",
      "description": "tool name field."
    },
    "requested_capability": {
      "type": "string",
      "description": "requested capability field."
    },
    "manifest_reference_id": {
      "type": "string",
      "description": "manifest reference id field."
    },
    "allow_deny_decision": {
      "type": "string",
      "enum": [
        "allow",
        "deny"
      ],
      "description": "allow deny decision field."
    },
    "risk_domain": {
      "type": "string",
      "description": "risk domain field."
    },
    "override_threshold_ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Maximum allowed override latency in milliseconds."
    },
    "actual_override_latency_ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Observed override latency in milliseconds."
    },
    "degradation_trigger_flag": {
      "type": "boolean",
      "description": "degradation trigger flag field."
    },
    "raw_event_id": {
      "type": "string",
      "description": "raw event id field."
    },
    "summary_event_id": {
      "type": "string",
      "description": "summary event id field."
    },
    "severity_delta_score": {
      "type": "number",
      "description": "severity delta score field."
    },
    "reviewer_disposition": {
      "type": "string",
      "description": "reviewer disposition field."
    },
    "auth_token_id": {
      "type": "string",
      "description": "auth token id field."
    },
    "requested_resource": {
      "type": "string",
      "description": "requested resource field."
    },
    "granted_scope": {
      "type": "string",
      "description": "granted scope field."
    },
    "scope_mismatch_flag": {
      "type": "boolean",
      "description": "scope mismatch flag field."
    },
    "query_hash": {
      "type": "string",
      "description": "query hash field."
    },
    "intent_score": {
      "type": "number",
      "description": "intent score field."
    },
    "refusal_flag": {
      "type": "boolean",
      "description": "refusal flag field."
    },
    "intervention_mode": {
      "type": "string",
      "description": "intervention mode field."
    },
    "signal_score": {
      "type": "number",
      "description": "signal score field."
    },
    "escalation_threshold": {
      "type": "number",
      "description": "escalation threshold field."
    },
    "escalation_decision": {
      "type": "string",
      "description": "escalation decision field."
    },
    "domain_risk_class": {
      "type": "string",
      "description": "CES domain risk class (e.g., R1-R4)."
    },
    "domain_confidence": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "Confidence score for domain classification."
    },
    "domain_signals": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Short domain detection signals."
    },
    "gate_triggered": {
      "type": "boolean",
      "description": "Whether a CES gate was triggered."
    },
    "gate_type": {
      "type": "string",
      "description": "CES gate type identifier."
    },
    "approval_required": {
      "type": "boolean",
      "description": "Whether human approval is required."
    },
    "required_approver_role": {
      "type": "string",
      "description": "Governance role required for approval."
    },
    "approval_status": {
      "type": "string",
      "enum": [
        "requested",
        "approved",
        "rejected",
        "timeout"
      ],
      "description": "Approval state for gated actions."
    },
    "escalation_event": {
      "type": [
        "object",
        "array"
      ],
      "description": "Minimal escalation metadata."
    },
    "chosen_action": {
      "type": "string",
      "description": "Action selected after gating logic."
    },
    "top_k_alternatives_agg": {
      "type": "array",
      "minItems": 3,
      "maxItems": 5,
      "items": {
        "type": "object",
        "required": [
          "category",
          "reason_short"
        ],
        "properties": {
          "category": {
            "type": "string"
          },
          "reason_short": {
            "type": "string"
          }
        },
        "additionalProperties": false
      },
      "description": "Aggregated top-K alternatives without chain-of-thought."
    },
    "constraints_triggered": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Constraints triggered by CES evaluation."
    },
    "safe_hold_invoked": {
      "type": "boolean",
      "description": "Whether safe-hold was invoked."
    },
    "uncertainty_score": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "Uncertainty score at decision time."
    },
    "time_pressure_signal": {
      "type": "boolean",
      "description": "Whether time-pressure signal was active."
    },
    "evidence_refs": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Evidence references supporting CES decision."
    }
  },
  "$defs": {
    "accountability_signatures": {
      "type": "object",
      "description": "Non-repudiation signatures across accountability boundaries.",
      "required": [
        "policy_owner_signature",
        "deployment_signature",
        "audit_export_signature"
      ],
      "properties": {
        "policy_owner_signature": {
          "type": "string",
          "description": "Policy owner signature."
        },
        "deployment_signature": {
          "type": "string",
          "description": "Deployment signature."
        },
        "override_actor_signature": {
          "type": "string",
          "description": "Override actor signature."
        },
        "audit_export_signature": {
          "type": "string",
          "description": "Audit export signature."
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
